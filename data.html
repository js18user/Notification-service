<!DOCTYPE html>
<html lang="eu">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="author" content="js18user">
        <link rel="icon" href="https:///www.w3.org/2008/site/images/favicon.ico" crossorigin>
        <title>admin</title>
    </head>
    <style>

.container {
   margin: 0 auto;
   width: 100%;
   max-width: 1920px;
   padding: 0 0px;
}
.main {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
.wind {
    width: 588px;
    height: 892px;
    text-align: center;
    padding: 10px;
    border: 2px solid #0000cc;
    /* border: 1px solid FireBrick; */
    border-radius: 10px;
    color: #0000cc;
    background-color: white;
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 2;
    margin: auto;
}
.main:target {display: block;}

main {
      max-width: 38rem;
      padding: 22rem;
      margin: auto;
}

h1, h3, h4, h5, h6 {
                  margin: 3em 0 1em;
                  color: blue;
                  background-color: white;
}

h2 {
   color: blue;
   background-color: white;
}
ul, ol {
        margin-bottom: 2em;
        color: #1d1d1d;
        font-family: sans-serif;
        width: 800px;
        margin: 9px;
        font-size: 17px;
        text-align: justify;
        line-height: 1;
}
td {padding:1px;}

button{ border-radius: 18%;
        border: 2px solid FireBrick;
        font-size: 13px;
        margin: 3px;
        line-height: 1.2;
        text-align: justify;
        width: 100px;
        background-color: RoyalBlue;
        color: white;
}

button:visited {color:green; text-decoration:none;}
button:hover   {color:red; text-decoration:underline; transform: scale(1.04);}
button:active  {color:yellow; text-decoration:underline;}

.begin {line-height: 50em;}

.scroll-table-body {
                    height: 840px;
                    overflow-x: auto;
                    color: DarkBlue;
                        margin-top: 0px;
                    margin-bottom: 20px;
                    border-bottom: 1px solid #eee;
}

.scroll-table table {
                        width:100%;
 /*                   table-layout: fixed;
  */                      border: none;
}

.scroll-table th {
                        font-weight: bold;
                        text-align: left;
                        border: none;
                        padding: 5px 15px;  /*  padding: 10px 15px;  */
                        background: #d8d8d8;
                        font-size: 18px;
                        border-left: 1px solid #ddd;
                        border-right: 1px solid #ddd;
                        color: MediumBlue;
}

.scroll-table td {
                        text-align: left;
                        border-left: 1px solid #ddd;
                        border-right: 1px solid #ddd;
                        padding: 0px 15px;
                        font-size: 16px;
                        vertical-align: top;
}

::-webkit-scrollbar {
                     width: 6px;
}
label {color: DarkBlue ;}

input    {
           background-color: RoyalBlue;
           color: white;
           border: 1px solid FireBrick;
           font-family: 'Uncut';
           font-size: 16px;
}

#distributionTeg {
           width: 162px;
}

#distributionMob {
           width: 60px;
}

#distributionText {
            width: 1000px;
}

#distributionStart_date {
            height: 20px;
            empty-cells: show;
}

#distributionEnd_date {
            height: 20px;
            empty-cells: show;
}

#saveBtn {
           background-color: LightSeaGreen;
           color: white;
}

#resetBtn {
           background-color: RoyalBlue;
           color: white;
}

#selectBtn {
            background-color: blue;
            color: white;
}

#deleteBtn {
            background-color: FireBrick;
            color: white;
}

#updateGlBtn {
             color: white;
             background-color: SteelBlue;
}

.updateDistribution {
             color: white;
             background-color: SteelBlue;
}

.deleteDistribution {
             color: white;
             background-color: FireBrick;
             border: 2px solid blue;
}

.begin  { line-height: 0%; }
.idr {width: 28px;}
.idm {width: 20px;}
.text {width: 24em;}
.teg {width: 1em;}

#footer {
        position: fixed;
        left: 0; bottom: 0;
        padding: 7px;
  /*      background: #d8d8d8;  Times New Roman */
        background: SteelBlue;
        color: MediumBlue;
        width: 100%;
}
#content {
            top: 24px;
            left: 550px;
            bottom: 50;
            right: 100;
            position: fixed;
            color: FireBrick;
            margin-bottom: 50px;
}
html {
  scroll-behavior: smooth;
}
    </style>

    <body translate="no">
      <nav class="container">
        <div id="content" class="errorMessage"></div>

        <div class="begin">
            <input type="hidden" id="distributionId">
            <input type="hidden" id="messageId">
            <p>
                <label for="distributionStart_date">Start date:</label>
                <input id="distributionStart_date" required type="datetime-local" spellcheck="true">
            </p>
            <p>
                 <label for="distributionEnd_date">End date:&nbsp;</label>
                <input id="distributionEnd_date" required type="datetime-local" spellcheck="true">
            </p>
            <p>
                <label for="distributionTeg">Teg:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <input id="distributionTeg" required type="text" list="list" >
                <datalist id="list">
                    <option value="message"></option>
                    <option value="message"></option>
                </datalist>
            </p>
            <p>
                <label for="distributionMob">Mob &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</label>
                <input  id="distributionMob" type="number" spellcheck="true" min="901" max="999" required>
            </p>
            <p>
                <label for="distributionText">Text:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <input id="distributionText" required type="text" placeholder="e.g. your message for clients">
            </p>
             <p>
                 <button id="saveBtn">Save</button>
                 <button id="resetBtn">Reset</button>
                 <button id="selectBtn">Select</button>
                 <button id="deleteBtn">Delete</button>
                 <button id="updateGlBtn">UpdateGlobal</button>
            </p>
        </div>
        <div class="scroll-table">
            <table>
                <thead>
                    <tr>
                        <th>|............................................................... MESSAGES ....................................................|
                            |...... DISTRIBUTIONS .....|
                        </th>
                        <th>&nbsp;&nbsp;ID&nbsp;</th>
                        <th>&nbsp;&nbsp;&nbsp;START DATE&nbsp;&nbsp;&nbsp;&nbsp;</th>
                        <th>&nbsp; END DATE &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                        <th> TEG &nbsp;</th>
                        <th>mb</th>
                        <th>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; TEXT &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</th>
                    </tr>
                </thead>
            </table>

            <div class="scroll-table-body">
                <table id="tableId" class="tbl">
                    <tbody id="sid">
                        <tr></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="footer"></div>
      </nav>
      <!--script src="http://127.0.0.1:8000/v1.js"></script-->
        <script async>
"use strict";
// vizual error mess
async function displayOnError(error) {
    let messageError = document.querySelector("div");
    messageError.setAttribute('class', "errorMessage");
    document.getElementById('content').textContent = '';
    messageError.append(error);
}
// message for display error
async function createMessageError(response) { return await "Error --> " + " " + response.status + " " + response.statusText; }
// Clearing table rows
async function removeTableBody() {tableId.replaceChild(document.createElement(tbs), tableId.tBodies[0]);}

// Receiving all distributions lists with message statistics
async function getDistributions() {
    let response = await fetch('/admin/distribution', {
        headers: { 'Content-Type': 'application/json' }
    });
    if (response.ok) {
        let distributions = await response.json(), rows = document.querySelector(tbs);
        await getDistribution(distributions[0], 0);
        for await (let distribution of distributions) {
            rows.append(row(distribution));
        }
        ;
        document.getElementById("distributionId").value = "";
    }
    else
        await displayOnError(await createMessageError(response) );
}
// Receiving all messages for the distribution
async function getMessages(distribution, status) {
    let url = '';
    status === "com" ? url = `/admin/message?id_distribution=${distribution.id}` :
        url = `/admin/message/status?id_distribution=${distribution.id}&status=${status}`;
    let response = await fetch(url, {
        headers: { 'Content-Type': 'application/json' }
    });
    if (response.ok)
        return await response.json();
    else
        await displayOnError(await createMessageError(response) );
}
// Getting a Single Distribution
async function getDistribution(distribution, list_number) {
    document.getElementById("distributionId").value = distribution.id;
    document.getElementById("distributionStart_date").value = distribution.start_date;
    document.getElementById("distributionEnd_date").value = distribution.end_date;
    document.getElementById("distributionTeg").value = distribution.teg;
    document.getElementById("distributionMob").value = distribution.mob;
    document.getElementById("distributionText").value = distribution.text;
    await displayOnError("Ready for Update distribution ID=" + distribution.id +
        ".   Change the attributes and click Save button. " +
        "  For Update others distributions click Update button by match. " +
        "  For Create a new Distribution click Reset button. " +
        "  Messages are ready for viewing. Click the appropriate button.");
}
// Getting a Single Distribution with message's statistic
async function getDistributionStatistic(id_number) {
    let response = await fetch(`/admin/statistic?id=${id_number}`, {
        headers: { 'Content-Type': 'application/json' }
    });
    if (response.ok)
        return await response.json();
    else
        await displayOnError(await createMessageError(response) );
}
// Adding a Distribution
async function createDistribution(distributionStart_date, distributionEnd_date, distributionTeg, distributionMob, distributionText) {
    let one = 1;
    let en = 900;
    if (distributionStart_date === "" ||
        distributionEnd_date === "" ||
        Date.now() > Date.parse(distributionStart_date) ||
        Date.now() > Date.parse(distributionEnd_date) ||
        Date.parse(distributionStart_date) > Date.parse(distributionEnd_date) ||
        distributionTeg === "" ||
        distributionText === "" ||
        distributionTeg.length < one ||
        distributionText.length < one ||
        distributionMob === "" ||
        distributionMob < en ||
        distributionMob > 999)
        await displayOnError("Error --> ... life is hard... very hard. It must be repeated..." + Date());
    else {
        await displayOnError("");
        let response = await fetch("/distribution", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start_date: distributionStart_date,
                end_date: distributionEnd_date,
                teg: distributionTeg,
                mob: distributionMob,
                text: distributionText,
            })
        });
        if (response.ok) {
            let distribution = await response.json();
            await getDistribution(distribution[0], 0);
            document.getElementById("distributionId").value = "";
            await displayOnError("Created distribution ID=" + distribution[0]['id'] +
                " " + response.status + " " + response.statusText +
                " Press the UpdateGlobal button to monitor the status of messages");
        }
        else
            await displayOnError(await createMessageError(response) );
    }
}
//  Distribution Update
async function editDistribution(id, start_date, end_date, teg, mob, text) {
    let response = await fetch("/distribution", {
        method: "PUT",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            distribution: { id: id, },
            upd: {
                start_date: start_date,
                end_date: end_date,
                teg: teg,
                mob: mob,
                text: text,
            },
        })
    });
    if (response.ok) {
        let listDistributionStatistic = await getDistributionStatistic(id);
        document.querySelector(`tr[data-rowid="${listDistributionStatistic[0].id}"]`).
            replaceWith(row(listDistributionStatistic[0]));
        await displayOnError("Updated distribution ID=" + id + " " + response.status + " " + response.statusText +
            " Press the UpdateGlobal button to monitor the status of messages");
    }
    else
        await displayOnError(await createMessageError(response) );
}
// Delete the distribution
async function deleteDistribution(distribution, list_number) {
    let response = await fetch(`/distribution`, {
        method: "DELETE",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            id: distribution.id,
        })
    });
    if (response.ok) {
        await displayOnError("Deleted distribution ID=" + distribution.id + " with messages");
        document.querySelector(`tr[data-rowid='${distribution.id}']`).remove();
    }
    else
        await displayOnError(await createMessageError(response) );
}
// Open window to view messages
async function showMessages(distribution, list_number, status) {
    await getDistribution(distribution, list_number);
    await displayMessage(distribution, status);
    return;
}
// Reset form data after submit
async function reset() {
    document.getElementById("distributionId").value =
        document.getElementById("distributionStart_date").value =
            document.getElementById("distributionEnd_date").value =
                document.getElementById("distributionText").value = "";
    [document.getElementById("distributionTeg").value,
        document.getElementById("distributionMob").value
    ] = ["message", "906"];
    await displayOnError("Ready for CREATE a new Distribution" +
        ". Enter the attributes and click Save button.\n ");
}
// Page refresh
async function updateGlobal() {
    let response = await fetch('/admin/distribution', {
        method: "GET",
        headers: { 'Content-Type': 'application/json' },
    });
    if (response.ok) {
        let distributions = await response.json();
        await removeTableBody();
        await getDistribution(distributions[0], 0);
        let rows = document.querySelector(tbs);
        for await (let distribution of distributions) {
            rows.append(row(distribution));
        }
        ;
        document.getElementById("distributionId").value = "";
        await displayOnError("All updated");
    }
    else
        await displayOnError(await createMessageError(response) );
}
// create distribution's string for table
async function row(distribution) {
    let trs = document.createElement("tr"), linksTd = document.createElement("td"), showCom = document.createElement("button"), showFormed = document.createElement("button"),
        showQueue = document.createElement("button"), showSent = document.createElement("button"), showFailure = document.createElement("button"),
        showExpired = document.createElement("button"), editLink = document.createElement("button"), removeLink = document.createElement("button");
    trs.setAttribute("data-rowid", distribution.id);
    showCom.append("Com ", distribution.com);
    showCom.addEventListener("click", async () => await showMessages(distribution, distribution.id, "com"));
    showFormed.append("Formed ", distribution.formed);
    showFormed.addEventListener("click", async () => await showMessages(distribution, distribution.id, "formed"));
    showQueue.append("Queue ", distribution.queue);
    showQueue.addEventListener("click", async () => await showMessages(distribution, distribution.id, "queue"));
    showSent.append("Sent ", distribution.sent);
    showSent.addEventListener("click", async () => await showMessages(distribution, distribution.id, "sent"));
    showFailure.append("Failure ", distribution.failure);
    showFailure.addEventListener("click", async () => await showMessages(distribution, distribution.id, "failure"));
    showExpired.append("Expired ", distribution.expired);
    showExpired.addEventListener("click", async () => await showMessages(distribution, distribution.id, "expired"));
    editLink.setAttribute('class', 'updateDistribution');
    editLink.append("Update");
    editLink.addEventListener("click", async () => await getDistribution(distribution, distribution.id));
    removeLink.setAttribute('class', 'deleteDistribution');
    removeLink.append("Delete");
    removeLink.addEventListener("click", async () => await deleteDistribution(distribution, distribution.id));
    linksTd.append(showCom, showFormed, showQueue, showSent, showFailure, showExpired, editLink, removeLink);
    trs.appendChild(linksTd);
    let idTd = document.createElement("td"), start_dateTd = document.createElement("td"), end_dateTd = document.createElement("td"),
        tegTd = document.createElement("td"), mobTd = document.createElement("td"), textTd = document.createElement("td");
    idTd.append(distribution.id);
    start_dateTd.append(distribution.start_date);
    end_dateTd.append(distribution.end_date);
    tegTd.setAttribute("class", "teg");
    tegTd.append(distribution.teg.substring(0, 8));
    mobTd.append(distribution.mob);
    textTd.setAttribute("class", "text");
    textTd.append(distribution.text);
    trs.append(idTd, start_dateTd, end_dateTd, tegTd, mobTd, textTd);
    return await trs;
}
// create message's string for table
async function rowMessage(message) {
    let trs = document.createElement("tr"), linksTd = document.createElement("td"), idTd = document.createElement("td"),
        start_dateTd = document.createElement("td"), phoneTd = document.createElement("td"),
        timezoneTd = document.createElement("td"), statusTd = document.createElement("td");
    trs.setAttribute("data-rowid", message.id);
    idTd.append(message.id);
    start_dateTd.append(message.start_date);
    phoneTd.append(message.phone);
    timezoneTd.append("00", message.timezone);
    statusTd.append(message.status);
    trs.append(idTd, start_dateTd, phoneTd, timezoneTd, statusTd);
    return await trs;
}
// Reset all
document.getElementById("resetBtn").addEventListener("click", async () => reset());
// UpdateGlobal
document.getElementById("updateGlBtn").addEventListener("click", async () => updateGlobal());
// Submitting the form for further use
document.getElementById("saveBtn").addEventListener("click", async () => {
    let id = document.getElementById("distributionId").value, start_date = document.getElementById("distributionStart_date").value,
        end_date = document.getElementById("distributionEnd_date").value, teg = document.getElementById("distributionTeg").value,
        mob = document.getElementById("distributionMob").value, text = document.getElementById("distributionText").value;
    id === "" ? await createDistribution(start_date, end_date, teg, mob, text) :
        await editDistribution(id, start_date, end_date, teg, mob, text);
});
// Create window for messages
async function displayMessage(distribution, status) {
    let messages = await getMessages(distribution, status),
        html = document.querySelector('html'),
        windowRight = document.createElement('div'), closeBtn = document.createElement('button'),
        divCom = document.createElement('div'), table = document.createElement('table'),
        tHead = document.createElement('tHead'), tr = document.createElement('tr'), messageId = document.createElement('th'),
        messageStart_date = document.createElement('th'), messagePhone = document.createElement('th'),
        messageTimezone = document.createElement('th'), messageStatus = document.createElement('th'),
        divBody = document.createElement('div'), rows = document.createElement(tbs);
    windowRight.setAttribute('class', 'wind');
    html.appendChild(windowRight);
    closeBtn.textContent = 'Close window';
    windowRight.appendChild(closeBtn);
    closeBtn.onclick = async function () { windowRight.parentNode.removeChild(windowRight); };
    divCom.setAttribute('class', "scroll-table");
    windowRight.appendChild(divCom);
    divCom.appendChild(table);
    table.appendChild(tHead);
    tHead.appendChild(tr);
    messageId.textContent = "(id)";
    tr.appendChild(messageId);
    messageStart_date.textContent = ".........Date operation.........";
    tr.appendChild(messageStart_date);
    messagePhone.textContent = "....Phone....";
    tr.appendChild(messagePhone);
    messageTimezone.textContent = "utc";
    tr.appendChild(messageTimezone);
    messageStatus.textContent = "Status";
    tr.appendChild(messageStatus);
    divBody.setAttribute('class', "scroll-table-body");
    divCom.appendChild(divBody);
    for await (let message of messages) {
        rows.append(rowMessage(message));
    }
    ;
    divBody.appendChild(rows);
}
//   start working
// let ssl = Symbol("msp");
let tbs = "TBody";
getDistributions();
        </script>
    </body>
</html>
